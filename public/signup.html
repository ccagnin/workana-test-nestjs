<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <form id="signupForm">
        <h1>Signup</h1>
        <label for="name">Nome Completo:</label>
        <input type="text" id="name" name="name" required>

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>

        <label for="password">Senha:</label>
        <input type="password" id="password" name="password" required>

        <label for="confirmPassword">Confirmar Senha:</label>
        <input type="password" id="confirmPassword" name="confirmPassword" required>

        <label for="street">Rua:</label>
        <input type="text" id="street" name="street" required>

        <label for="neighborhood">Bairro:</label>
        <input type="text" id="neighborhood" name="neighborhood" required>

        <label for="number">Número:</label>
        <input type="text" id="number" name="number" required>

        <label for="complement">Complemento:</label>
        <input type="text" id="complement" name="complement">

        <label for="city">Cidade:</label>
        <input type="text" id="city" name="city" required>

        <label for="state">Estado:</label>
        <input type="text" id="state" name="state" required>

        <label for="zip">CEP:</label>
        <input type="text" id="zip" name="zip" required>

        <button type="submit">Cadastrar</button>
    </form>
    <script>
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const zip = document.getElementById('zip').value;

            try {
                const isValidZip = await validateZip(zip);
                if (!isValidZip) {
                    alert('CEP inválido');
                    window.location.reload();
                    return;
                }

                const formData = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value,
                    confirmPassword: document.getElementById('confirmPassword').value,
                    addresses: {
                        street: document.getElementById('street').value,
                        neighborhood: document.getElementById('neighborhood').value,
                        number: document.getElementById('number').value,
                        complement: document.getElementById('complement').value,
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        zip: document.getElementById('zip').value
                    }
                };

                const response = await fetch('http://localhost:4000/auth/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('Cadastro realizado com sucesso!');
                    window.location.href = 'login.html';
                } else {
                    const error = await response.json();
                    alert(error.message);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        async function validateZip(zip) {
            try {
                const response = await fetch(`https://viacep.com.br/ws/${zip}/json/`);
                const data = await response.json();
                return !data.erro;
            } catch (error) {
                console.error('Error:', error);
                return false;
            }
        }
    </script>
</body>
</html>
